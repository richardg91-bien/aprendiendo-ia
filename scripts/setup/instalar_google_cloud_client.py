#!/usr/bin/env python3
"""
üîß INSTALADOR DE GOOGLE CLOUD API KEYS CLIENT
=============================================

Instala y configura la biblioteca oficial de Google Cloud API Keys Client
seg√∫n la documentaci√≥n oficial.

Caracter√≠sticas:
‚úÖ Instalaci√≥n autom√°tica de google-cloud-api-keys
‚úÖ Configuraci√≥n de entorno virtual
‚úÖ Verificaci√≥n de Python >= 3.7
‚úÖ Configuraci√≥n de logging avanzado
‚úÖ Integraci√≥n con sistema ARIA existente

Basado en documentaci√≥n oficial:
https://cloud.google.com/python/docs/reference/apikeys/latest

Fecha: 22 de octubre de 2025
"""

import sys
import os
import subprocess
import logging
from pathlib import Path

class GoogleCloudClientInstaller:
    """Instalador de Google Cloud API Keys Client oficial"""
    
    def __init__(self):
        self.python_version = sys.version_info
        self.venv_path = Path("venv")
        self.requirements_added = []
        
        print("üîß Instalador de Google Cloud API Keys Client")
        print("=" * 50)
    
    def check_python_version(self) -> bool:
        """Verifica versi√≥n de Python seg√∫n documentaci√≥n oficial"""
        print("üêç VERIFICANDO VERSI√ìN DE PYTHON")
        print("-" * 35)
        
        current_version = f"{self.python_version.major}.{self.python_version.minor}"
        print(f"   Versi√≥n actual: Python {current_version}")
        
        # Verificar seg√∫n documentaci√≥n: Python >= 3.7, incluyendo 3.14
        if self.python_version >= (3, 7):
            print(f"‚úÖ Python {current_version} es compatible (>=3.7)")
            return True
        else:
            print(f"‚ùå Python {current_version} no es compatible")
            print("üí° Documentaci√≥n oficial requiere: Python >= 3.7")
            print("   Actualizar Python antes de continuar")
            return False
    
    def check_virtual_environment(self) -> bool:
        """Verifica si est√° en entorno virtual"""
        print(f"\nüì¶ VERIFICANDO ENTORNO VIRTUAL")
        print("-" * 32)
        
        # Verificar si estamos en venv
        in_venv = hasattr(sys, 'real_prefix') or (hasattr(sys, 'base_prefix') and sys.base_prefix != sys.prefix)
        
        if in_venv:
            print("‚úÖ Ejecut√°ndose en entorno virtual")
            print(f"   Ruta: {sys.prefix}")
            return True
        else:
            print("‚ö†Ô∏è No se detect√≥ entorno virtual")
            print("üí° Recomendado usar entorno virtual para aislamiento")
            
            choice = input("¬øContinuar sin entorno virtual? (s/n): ").lower()
            return choice == 's'
    
    def install_google_cloud_api_keys(self) -> bool:
        """Instala google-cloud-api-keys seg√∫n documentaci√≥n oficial"""
        print(f"\nüì• INSTALANDO GOOGLE CLOUD API KEYS CLIENT")
        print("-" * 45)
        
        try:
            # Comando seg√∫n documentaci√≥n oficial
            print("üîÑ Ejecutando: pip install google-cloud-api-keys")
            
            result = subprocess.run([
                sys.executable, '-m', 'pip', 'install', 'google-cloud-api-keys'
            ], capture_output=True, text=True, timeout=300)
            
            if result.returncode == 0:
                print("‚úÖ google-cloud-api-keys instalado correctamente")
                self.requirements_added.append("google-cloud-api-keys")
                
                # Verificar instalaci√≥n
                try:
                    import google.cloud.api_keys_v1
                    print("‚úÖ M√≥dulo importado correctamente")
                    return True
                except ImportError as e:
                    print(f"‚ùå Error importando m√≥dulo: {e}")
                    return False
            else:
                print(f"‚ùå Error en instalaci√≥n: {result.stderr}")
                return False
                
        except subprocess.TimeoutExpired:
            print("‚ùå Timeout en instalaci√≥n (>300s)")
            return False
        except Exception as e:
            print(f"‚ùå Error inesperado: {e}")
            return False
    
    def install_additional_dependencies(self) -> bool:
        """Instala dependencias adicionales recomendadas"""
        print(f"\nüì¶ INSTALANDO DEPENDENCIAS ADICIONALES")
        print("-" * 40)
        
        additional_packages = [
            'google-auth',
            'google-auth-oauthlib',
            'google-auth-httplib2',
            'grpcio'
        ]
        
        installed_count = 0
        
        for package in additional_packages:
            try:
                print(f"üîÑ Instalando {package}...")
                
                result = subprocess.run([
                    sys.executable, '-m', 'pip', 'install', package
                ], capture_output=True, text=True, timeout=120)
                
                if result.returncode == 0:
                    print(f"‚úÖ {package} instalado")
                    self.requirements_added.append(package)
                    installed_count += 1
                else:
                    print(f"‚ö†Ô∏è {package} no se pudo instalar")
                    
            except Exception as e:
                print(f"‚ö†Ô∏è Error con {package}: {e}")
        
        print(f"\nüìä Dependencias instaladas: {installed_count}/{len(additional_packages)}")
        return installed_count > 0
    
    def configure_logging(self) -> bool:
        """Configura logging seg√∫n documentaci√≥n oficial"""
        print(f"\nüìã CONFIGURANDO LOGGING AVANZADO")
        print("-" * 35)
        
        try:
            # Configuraci√≥n seg√∫n documentaci√≥n oficial
            
            # 1. Configurar logger base de Google
            base_logger = logging.getLogger("google")
            base_logger.addHandler(logging.StreamHandler())
            base_logger.setLevel(logging.INFO)  # Cambiar a DEBUG si necesario
            
            # 2. Configurar logger espec√≠fico para API Keys
            api_keys_logger = logging.getLogger("google.cloud.api_keys_v1")
            api_keys_logger.addHandler(logging.StreamHandler())
            api_keys_logger.setLevel(logging.INFO)
            
            # 3. Configurar propagaci√≥n seg√∫n documentaci√≥n
            logging.getLogger("google").propagate = True
            
            print("‚úÖ Logging configurado seg√∫n documentaci√≥n oficial")
            print("   ‚Ä¢ Logger base: google (nivel INFO)")
            print("   ‚Ä¢ Logger espec√≠fico: google.cloud.api_keys_v1")
            print("   ‚Ä¢ Propagaci√≥n habilitada")
            
            # Variable de entorno opcional
            os.environ['GOOGLE_SDK_PYTHON_LOGGING_SCOPE'] = 'google.cloud.api_keys_v1'
            print("‚úÖ Variable GOOGLE_SDK_PYTHON_LOGGING_SCOPE configurada")
            
            return True
            
        except Exception as e:
            print(f"‚ùå Error configurando logging: {e}")
            return False
    
    def verify_installation(self) -> bool:
        """Verifica que la instalaci√≥n sea correcta"""
        print(f"\nüß™ VERIFICANDO INSTALACI√ìN")
        print("-" * 25)
        
        verification_results = {}
        
        # Verificar importaci√≥n principal
        try:
            from google.cloud import api_keys_v1
            verification_results['main_import'] = True
            print("‚úÖ Importaci√≥n principal: google.cloud.api_keys_v1")
        except ImportError as e:
            verification_results['main_import'] = False
            print(f"‚ùå Error importaci√≥n principal: {e}")
        
        # Verificar cliente
        try:
            from google.cloud.api_keys_v1 import ApiKeysClient
            verification_results['client'] = True
            print("‚úÖ Cliente disponible: ApiKeysClient")
        except ImportError as e:
            verification_results['client'] = False
            print(f"‚ùå Error cliente: {e}")
        
        # Verificar autenticaci√≥n
        try:
            import google.auth
            credentials, project = google.auth.default()
            verification_results['auth'] = True
            print(f"‚úÖ Autenticaci√≥n disponible (proyecto: {project or 'N/A'})")
        except Exception as e:
            verification_results['auth'] = False
            print(f"‚ö†Ô∏è Autenticaci√≥n pendiente: {e}")
        
        # Verificar logging
        try:
            logger = logging.getLogger("google.cloud.api_keys_v1")
            verification_results['logging'] = bool(logger.handlers)
            status = "Configurado" if logger.handlers else "Sin configurar"
            print(f"‚úÖ Logging: {status}")
        except:
            verification_results['logging'] = False
            print("‚ùå Error verificando logging")
        
        # Resultado general
        passed = sum(1 for result in verification_results.values() if result)
        total = len(verification_results)
        
        print(f"\nüìä Verificaci√≥n: {passed}/{total} elementos correctos")
        
        return passed >= 2  # Al menos importaci√≥n y cliente funcionando
    
    def update_requirements_file(self):
        """Actualiza archivo requirements.txt"""
        print(f"\nüìÑ ACTUALIZANDO REQUIREMENTS.TXT")
        print("-" * 32)
        
        if not self.requirements_added:
            print("‚ö†Ô∏è No hay nuevos paquetes para agregar")
            return
        
        requirements_file = Path("backend/requirements.txt")
        
        try:
            # Leer requirements existentes
            existing_requirements = set()
            if requirements_file.exists():
                with open(requirements_file, 'r', encoding='utf-8') as f:
                    existing_requirements = {line.strip() for line in f if line.strip() and not line.startswith('#')}
            
            # Agregar nuevos paquetes
            new_requirements = []
            for package in self.requirements_added:
                if package not in existing_requirements:
                    new_requirements.append(package)
            
            if new_requirements:
                # Crear directorio si no existe
                requirements_file.parent.mkdir(parents=True, exist_ok=True)
                
                # Agregar nuevos requirements
                with open(requirements_file, 'a', encoding='utf-8') as f:
                    if requirements_file.stat().st_size > 0:
                        f.write('\n')
                    f.write(f'\n# Google Cloud API Keys Client - {self._get_timestamp()}\n')
                    for req in new_requirements:
                        f.write(f'{req}\n')
                
                print(f"‚úÖ Agregados {len(new_requirements)} paquetes a requirements.txt")
                for req in new_requirements:
                    print(f"   + {req}")
            else:
                print("‚ÑπÔ∏è Todos los paquetes ya estaban en requirements.txt")
                
        except Exception as e:
            print(f"‚ùå Error actualizando requirements.txt: {e}")
    
    def _get_timestamp(self) -> str:
        """Obtiene timestamp actual"""
        from datetime import datetime
        return datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    def create_example_usage(self):
        """Crea ejemplo de uso del cliente"""
        print(f"\nüìù CREANDO EJEMPLO DE USO")
        print("-" * 27)
        
        example_code = '''#!/usr/bin/env python3
"""
üîë EJEMPLO DE USO - Google Cloud API Keys Client
==============================================

Ejemplo b√°sico de uso del cliente oficial de Google Cloud API Keys
seg√∫n la documentaci√≥n oficial.

Basado en: https://cloud.google.com/python/docs/reference/apikeys/latest
"""

import os
import logging
from google.cloud import api_keys_v1
from google.auth import default

# Configurar logging seg√∫n documentaci√≥n oficial
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("google.cloud.api_keys_v1")

def list_api_keys(project_id: str):
    """Lista todas las claves API del proyecto"""
    try:
        # Crear cliente seg√∫n documentaci√≥n
        client = api_keys_v1.ApiKeysClient()
        
        # Configurar request
        request = api_keys_v1.ListKeysRequest(
            parent=f"projects/{project_id}/locations/global"
        )
        
        # Ejecutar request
        print(f"üîç Listando claves API para proyecto: {project_id}")
        page_result = client.list_keys(request=request)
        
        # Procesar resultados
        keys_found = 0
        for response in page_result:
            keys_found += 1
            print(f"   üîë Clave {keys_found}: {response.name}")
            print(f"      Display Name: {response.display_name}")
            print(f"      Created: {response.create_time}")
            print()
        
        if keys_found == 0:
            print("   ‚ÑπÔ∏è No se encontraron claves API")
        
        return keys_found
        
    except Exception as e:
        logger.error(f"Error listando claves API: {e}")
        return 0

def create_api_key(project_id: str, display_name: str):
    """Crea nueva clave API"""
    try:
        # Crear cliente
        client = api_keys_v1.ApiKeysClient()
        
        # Configurar clave API
        api_key = api_keys_v1.Key()
        api_key.display_name = display_name
        
        # Configurar request
        request = api_keys_v1.CreateKeyRequest(
            parent=f"projects/{project_id}/locations/global",
            key=api_key
        )
        
        print(f"üî® Creando clave API: {display_name}")
        
        # Ejecutar request (operaci√≥n as√≠ncrona)
        operation = client.create_key(request=request)
        
        print("‚è≥ Esperando completaci√≥n...")
        response = operation.result()
        
        print(f"‚úÖ Clave API creada exitosamente")
        print(f"   Nombre: {response.name}")
        print(f"   Key String: {response.key_string}")
        
        return response.key_string
        
    except Exception as e:
        logger.error(f"Error creando clave API: {e}")
        return None

def main():
    """Funci√≥n principal de ejemplo"""
    print("üîë EJEMPLO DE Google Cloud API Keys Client")
    print("=" * 45)
    
    # Obtener credenciales y proyecto
    try:
        credentials, project_id = default()
        
        if not project_id:
            print("‚ùå No se detect√≥ project_id")
            print("üí° Configurar: gcloud config set project TU_PROJECT_ID")
            return
        
        print(f"üìä Proyecto detectado: {project_id}")
        
        # Listar claves existentes
        keys_count = list_api_keys(project_id)
        
        # Crear nueva clave si se desea
        if keys_count < 5:  # L√≠mite razonable
            create_choice = input("\\nüî® ¬øCrear nueva clave API? (s/n): ").lower()
            
            if create_choice == 's':
                display_name = input("üìù Nombre para la clave: ").strip()
                if display_name:
                    new_key = create_api_key(project_id, display_name)
                    
                    if new_key:
                        print("\\nüí° PR√ìXIMOS PASOS:")
                        print(f"   1. Configurar variable de entorno:")
                        print(f"      set GOOGLE_CLOUD_API_KEY={new_key}")
                        print(f"   2. Integrar con sistema ARIA")
        else:
            print(f"‚ÑπÔ∏è Proyecto ya tiene {keys_count} claves API")
        
    except Exception as e:
        logger.error(f"Error en ejemplo: {e}")

if __name__ == "__main__":
    main()
'''
        
        example_file = Path("ejemplo_google_cloud_api_keys.py")
        
        try:
            with open(example_file, 'w', encoding='utf-8') as f:
                f.write(example_code)
            
            print(f"‚úÖ Ejemplo creado: {example_file}")
            print("üí° Ejecutar: python ejemplo_google_cloud_api_keys.py")
            
        except Exception as e:
            print(f"‚ùå Error creando ejemplo: {e}")
    
    def show_next_steps(self):
        """Muestra pr√≥ximos pasos"""
        print(f"\nüìã PR√ìXIMOS PASOS")
        print("=" * 20)
        
        print("üîß CONFIGURACI√ìN B√ÅSICA:")
        print("   1. Instalar y configurar gcloud CLI")
        print("   2. Autenticar: gcloud auth application-default login")
        print("   3. Configurar proyecto: gcloud config set project TU_PROJECT_ID")
        print()
        
        print("üîë GESTI√ìN DE CLAVES API:")
        print("   1. Ejecutar ejemplo: python ejemplo_google_cloud_api_keys.py")
        print("   2. Configurar variable: set GOOGLE_CLOUD_API_KEY=tu_clave")
        print("   3. Probar integraci√≥n: python verificar_google_cloud.py")
        print()
        
        print("üöÄ INTEGRACI√ìN CON ARIA:")
        print("   1. Probar sistema: python prueba_respuestas_inteligentes.py")
        print("   2. Servidor completo: python aria_servidor_multilingue.py")
        print("   3. Sistema completo: python prueba_sistema_completo.py")
        print()
        
        print("üìö DOCUMENTACI√ìN:")
        print("   ‚Ä¢ Cliente API Keys: https://cloud.google.com/python/docs/reference/apikeys/latest")
        print("   ‚Ä¢ Autenticaci√≥n: https://cloud.google.com/docs/authentication")
        print("   ‚Ä¢ Logging: Configurado seg√∫n documentaci√≥n oficial")
    
    def run_installation(self) -> bool:
        """Ejecuta instalaci√≥n completa"""
        print("üöÄ INICIANDO INSTALACI√ìN DE GOOGLE CLOUD API KEYS CLIENT")
        print("=" * 60)
        
        steps_results = {}
        
        try:
            # Paso 1: Verificar Python
            steps_results['python'] = self.check_python_version()
            if not steps_results['python']:
                return False
            
            # Paso 2: Verificar entorno virtual
            steps_results['venv'] = self.check_virtual_environment()
            if not steps_results['venv']:
                return False
            
            # Paso 3: Instalar cliente principal
            steps_results['main_client'] = self.install_google_cloud_api_keys()
            
            # Paso 4: Instalar dependencias adicionales
            steps_results['dependencies'] = self.install_additional_dependencies()
            
            # Paso 5: Configurar logging
            steps_results['logging'] = self.configure_logging()
            
            # Paso 6: Verificar instalaci√≥n
            steps_results['verification'] = self.verify_installation()
            
            # Paso 7: Actualizar requirements
            self.update_requirements_file()
            
            # Paso 8: Crear ejemplo
            self.create_example_usage()
            
            # Resumen
            print(f"\nüìä RESUMEN DE INSTALACI√ìN")
            print("=" * 28)
            
            for step, result in steps_results.items():
                status = "‚úÖ Exitoso" if result else "‚ùå Fall√≥"
                print(f"   {step.replace('_', ' ').title()}: {status}")
            
            successful_steps = sum(1 for result in steps_results.values() if result)
            total_steps = len(steps_results)
            
            if successful_steps >= 4:  # Criterio m√≠nimo de √©xito
                print(f"\nüéâ INSTALACI√ìN EXITOSA ({successful_steps}/{total_steps})")
                self.show_next_steps()
                return True
            else:
                print(f"\n‚ö†Ô∏è INSTALACI√ìN PARCIAL ({successful_steps}/{total_steps})")
                print("üí° Revisar errores y reintentar")
                return False
                
        except KeyboardInterrupt:
            print(f"\n‚èπÔ∏è Instalaci√≥n interrumpida por el usuario")
            return False
        except Exception as e:
            print(f"\n‚ùå Error durante instalaci√≥n: {e}")
            return False

def main():
    """Funci√≥n principal del instalador"""
    installer = GoogleCloudClientInstaller()
    
    print("üéØ Este instalador configurar√°:")
    print("   ‚Ä¢ google-cloud-api-keys (cliente oficial)")
    print("   ‚Ä¢ Dependencias de autenticaci√≥n")
    print("   ‚Ä¢ Logging avanzado seg√∫n documentaci√≥n")
    print("   ‚Ä¢ Ejemplo de uso funcional")
    print("   ‚Ä¢ Integraci√≥n con sistema ARIA")
    print()
    
    choice = input("¬øContinuar con la instalaci√≥n? (s/n): ").lower()
    
    if choice == 's':
        success = installer.run_installation()
        
        if success:
            print("\nüéâ ¬°Instalaci√≥n completada exitosamente!")
            print("üí° Revisar pr√≥ximos pasos arriba")
            return True
        else:
            print("\n‚ö†Ô∏è Instalaci√≥n incompleta. Revisar errores.")
            return False
    else:
        print("üëã Instalaci√≥n cancelada")
        return False

if __name__ == "__main__":
    main()