#!/usr/bin/env python3
"""
üìã VERIFICACI√ìN COMPLETA: GOOGLE CLOUD API KEYS CLIENT + ARIA
============================================================

Verifica la instalaci√≥n y configuraci√≥n completa del cliente oficial
de Google Cloud API Keys integrado con el sistema ARIA.

Incluye:
‚úÖ Verificaci√≥n de google-cloud-api-keys
‚úÖ Estado de autenticaci√≥n y credenciales
‚úÖ Integraci√≥n con sistema ARIA existente
‚úÖ Pruebas de funcionalidad
‚úÖ Diagn√≥stico de problemas comunes

Basado en documentaci√≥n oficial de Google Cloud
Fecha: 22 de octubre de 2025
"""

import sys
import os
import subprocess
import json
import logging
from pathlib import Path
from datetime import datetime
from typing import Dict, List, Optional

# Configurar logging b√°sico
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

class GoogleCloudAriaVerificator:
    """Verificador completo de Google Cloud + ARIA"""
    
    def __init__(self):
        self.logger = logging.getLogger(__name__)
        self.verification_results = {}
        self.recommendations = []
        
        print("üîç VERIFICADOR GOOGLE CLOUD API KEYS CLIENT + ARIA")
        print("=" * 55)
        print(f"Iniciado: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print()
    
    def verify_python_environment(self) -> Dict:
        """Verifica entorno Python y dependencias"""
        print("üêç VERIFICANDO ENTORNO PYTHON")
        print("-" * 32)
        
        results = {
            'python_version': None,
            'virtual_env': False,
            'pip_available': False,
            'packages_installed': {}
        }
        
        # Verificar versi√≥n de Python
        python_version = f"{sys.version_info.major}.{sys.version_info.minor}.{sys.version_info.micro}"
        results['python_version'] = python_version
        
        print(f"   Python: {python_version}")
        
        if sys.version_info >= (3, 7):
            print("   ‚úÖ Versi√≥n compatible (>=3.7)")
        else:
            print("   ‚ùå Versi√≥n no compatible (requiere >=3.7)")
            self.recommendations.append("Actualizar Python a versi√≥n 3.7 o superior")
        
        # Verificar entorno virtual
        in_venv = hasattr(sys, 'real_prefix') or (hasattr(sys, 'base_prefix') and sys.base_prefix != sys.prefix)
        results['virtual_env'] = in_venv
        
        if in_venv:
            print(f"   ‚úÖ Entorno virtual activo: {sys.prefix}")
        else:
            print("   ‚ö†Ô∏è No se detect√≥ entorno virtual")
            self.recommendations.append("Usar entorno virtual para aislamiento de dependencias")
        
        # Verificar pip
        try:
            import pip
            results['pip_available'] = True
            print("   ‚úÖ pip disponible")
        except ImportError:
            results['pip_available'] = False
            print("   ‚ùå pip no disponible")
        
        # Verificar paquetes instalados
        packages_to_check = [
            'google-cloud-api-keys',
            'google-auth',
            'google-auth-oauthlib',
            'google-auth-httplib2',
            'grpcio',
            'requests'
        ]
        
        print("   üì¶ Paquetes Google Cloud:")
        for package in packages_to_check:
            try:
                result = subprocess.run([
                    sys.executable, '-m', 'pip', 'show', package
                ], capture_output=True, text=True, timeout=10)
                
                if result.returncode == 0:
                    # Extraer versi√≥n
                    for line in result.stdout.split('\n'):
                        if line.startswith('Version:'):
                            version = line.split(':', 1)[1].strip()
                            results['packages_installed'][package] = version
                            print(f"      ‚úÖ {package}: {version}")
                            break
                    else:
                        results['packages_installed'][package] = "installed"
                        print(f"      ‚úÖ {package}: instalado")
                else:
                    results['packages_installed'][package] = None
                    print(f"      ‚ùå {package}: no instalado")
                    
            except Exception as e:
                results['packages_installed'][package] = None
                print(f"      ‚ö†Ô∏è {package}: error verificando")
        
        return results
    
    def verify_google_cloud_client(self) -> Dict:
        """Verifica cliente de Google Cloud API Keys"""
        print(f"\nüîë VERIFICANDO GOOGLE CLOUD API KEYS CLIENT")
        print("-" * 45)
        
        results = {
            'import_methods': {},
            'client_available': False,
            'auth_available': False,
            'credentials_configured': False
        }
        
        # Probar diferentes m√©todos de importaci√≥n
        import_methods = [
            ('google.cloud.apikeys_v1', 'from google.cloud import apikeys_v1'),
            ('google.cloud.api_keys.v1', 'from google.cloud.api_keys import v1'),
            ('google.cloud.api_keys_v1', 'from google.cloud import api_keys_v1')
        ]
        
        print("   üì• M√©todos de importaci√≥n:")
        
        for module_name, import_statement in import_methods:
            try:
                exec(import_statement)
                results['import_methods'][module_name] = True
                print(f"      ‚úÖ {module_name}: disponible")
            except ImportError as e:
                results['import_methods'][module_name] = False
                print(f"      ‚ùå {module_name}: {str(e)[:50]}...")
        
        # Verificar si alg√∫n m√©todo de importaci√≥n funcion√≥
        if any(results['import_methods'].values()):
            results['client_available'] = True
            print("   ‚úÖ Cliente API Keys disponible")
        else:
            print("   ‚ùå Cliente API Keys no disponible")
            self.recommendations.append("Verificar instalaci√≥n: pip install google-cloud-api-keys")
        
        # Verificar autenticaci√≥n
        print("   üîê Autenticaci√≥n:")
        try:
            import google.auth
            credentials, project = google.auth.default()
            
            results['auth_available'] = True
            print("      ‚úÖ M√≥dulo google.auth disponible")
            
            if credentials:
                results['credentials_configured'] = True
                print(f"      ‚úÖ Credenciales configuradas")
                print(f"      üìä Proyecto: {project or 'No detectado'}")
            else:
                print("      ‚ö†Ô∏è Credenciales no configuradas")
                self.recommendations.append("Configurar credenciales: gcloud auth application-default login")
                
        except ImportError:
            results['auth_available'] = False
            print("      ‚ùå google.auth no disponible")
        except Exception as e:
            print(f"      ‚ö†Ô∏è Error en autenticaci√≥n: {str(e)[:50]}...")
            self.recommendations.append("Configurar credenciales de Google Cloud")
        
        return results
    
    def verify_aria_integration(self) -> Dict:
        """Verifica integraci√≥n con sistema ARIA"""
        print(f"\nü§ñ VERIFICANDO INTEGRACI√ìN CON ARIA")
        print("-" * 36)
        
        results = {
            'auto_learning_available': False,
            'config_files_found': [],
            'google_cloud_apis_available': False,
            'multilingual_apis_available': False
        }
        
        # Verificar sistema de aprendizaje avanzado
        print("   üß† Sistema de aprendizaje:")
        try:
            sys.path.append('backend/src')
            from auto_learning_advanced import aria_advanced_learning
            
            results['auto_learning_available'] = True
            print("      ‚úÖ auto_learning_advanced disponible")
            
            # Probar status
            try:
                status = aria_advanced_learning.get_status()
                knowledge_count = status.get('total_knowledge', 0)
                confidence = status.get('confidence', 0)
                
                print(f"      üìä Conocimiento: {knowledge_count} elementos")
                print(f"      üìà Confianza: {confidence:.1f}%")
                
            except Exception as e:
                print(f"      ‚ö†Ô∏è Error obteniendo status: {str(e)[:30]}...")
                
        except ImportError:
            print("      ‚ùå auto_learning_advanced no disponible")
            self.recommendations.append("Verificar ruta del sistema de aprendizaje ARIA")
        
        # Verificar archivos de configuraci√≥n
        print("   ‚öôÔ∏è Archivos de configuraci√≥n:")
        config_files = [
            'config/settings.py',
            'backend/config/settings.py', 
            'backend/src/google_cloud_apis.py',
            'aria_google_cloud_integration.py'
        ]
        
        for config_file in config_files:
            if Path(config_file).exists():
                results['config_files_found'].append(config_file)
                print(f"      ‚úÖ {config_file}")
            else:
                print(f"      ‚ùå {config_file}")
        
        # Verificar APIs de Google Cloud
        print("   ‚òÅÔ∏è APIs de Google Cloud:")
        try:
            sys.path.append('backend/src')
            import google_cloud_apis
            
            results['google_cloud_apis_available'] = True
            print("      ‚úÖ google_cloud_apis.py disponible")
            
        except ImportError:
            print("      ‚ùå google_cloud_apis.py no disponible")
        
        # Verificar APIs multiling√ºes
        print("   üåê APIs multiling√ºes:")
        try:
            import multilingual_apis_free
            results['multilingual_apis_available'] = True
            print("      ‚úÖ multilingual_apis_free disponible")
            
        except ImportError:
            print("      ‚ùå multilingual_apis_free no disponible")
        
        return results
    
    def verify_gcloud_cli(self) -> Dict:
        """Verifica gcloud CLI y configuraci√≥n"""
        print(f"\n‚ö° VERIFICANDO GCLOUD CLI")
        print("-" * 25)
        
        results = {
            'gcloud_installed': False,
            'gcloud_version': None,
            'authenticated': False,
            'project_configured': False,
            'current_project': None
        }
        
        # Verificar instalaci√≥n de gcloud
        try:
            result = subprocess.run(['gcloud', '--version'], 
                                  capture_output=True, text=True, timeout=10)
            
            if result.returncode == 0:
                results['gcloud_installed'] = True
                # Extraer versi√≥n
                for line in result.stdout.split('\n'):
                    if 'Google Cloud SDK' in line:
                        results['gcloud_version'] = line.strip()
                        print(f"   ‚úÖ gcloud CLI instalado: {line.strip()}")
                        break
                
                # Verificar autenticaci√≥n
                try:
                    auth_result = subprocess.run(['gcloud', 'auth', 'list'], 
                                               capture_output=True, text=True, timeout=10)
                    
                    if auth_result.returncode == 0 and 'ACTIVE' in auth_result.stdout:
                        results['authenticated'] = True
                        print("   ‚úÖ Usuario autenticado")
                    else:
                        print("   ‚ö†Ô∏è Usuario no autenticado")
                        self.recommendations.append("Autenticar con: gcloud auth login")
                        
                except Exception:
                    print("   ‚ö†Ô∏è No se pudo verificar autenticaci√≥n")
                
                # Verificar proyecto configurado
                try:
                    project_result = subprocess.run(['gcloud', 'config', 'get-value', 'project'], 
                                                  capture_output=True, text=True, timeout=10)
                    
                    if project_result.returncode == 0 and project_result.stdout.strip():
                        project = project_result.stdout.strip()
                        if project != '(unset)':
                            results['project_configured'] = True
                            results['current_project'] = project
                            print(f"   ‚úÖ Proyecto configurado: {project}")
                        else:
                            print("   ‚ö†Ô∏è Proyecto no configurado")
                            self.recommendations.append("Configurar proyecto: gcloud config set project TU_PROJECT_ID")
                    else:
                        print("   ‚ö†Ô∏è No se pudo obtener proyecto")
                        
                except Exception:
                    print("   ‚ö†Ô∏è Error verificando proyecto")
            else:
                print("   ‚ùå gcloud CLI no responde correctamente")
                
        except FileNotFoundError:
            results['gcloud_installed'] = False
            print("   ‚ùå gcloud CLI no instalado")
            self.recommendations.append("Instalar gcloud CLI: https://cloud.google.com/sdk/docs/install")
        except subprocess.TimeoutExpired:
            print("   ‚ùå gcloud CLI timeout")
        except Exception as e:
            print(f"   ‚ùå Error verificando gcloud: {str(e)[:30]}...")
        
        return results
    
    def run_integration_tests(self) -> Dict:
        """Ejecuta pruebas de integraci√≥n"""
        print(f"\nüß™ EJECUTANDO PRUEBAS DE INTEGRACI√ìN")
        print("-" * 37)
        
        results = {
            'aria_google_cloud_test': False,
            'example_execution': False,
            'config_creation': False
        }
        
        # Prueba 1: Importar integraci√≥n ARIA Google Cloud
        print("   üîó Prueba integraci√≥n ARIA-Google Cloud:")
        try:
            from aria_google_cloud_integration import aria_google_cloud
            results['aria_google_cloud_test'] = True
            print("      ‚úÖ Integraci√≥n importada exitosamente")
            
            # Probar obtener estado
            try:
                status = aria_google_cloud.get_enhanced_services_status()
                google_available = status.get('google_cloud', {}).get('available', False)
                aria_available = status.get('aria_integration', {}).get('learning_system', False)
                
                print(f"      üìä Google Cloud: {'‚úÖ' if google_available else '‚ùå'}")
                print(f"      üìä ARIA Learning: {'‚úÖ' if aria_available else '‚ùå'}")
                
            except Exception as e:
                print(f"      ‚ö†Ô∏è Error obteniendo estado: {str(e)[:30]}...")
                
        except ImportError as e:
            print(f"      ‚ùå Error importando: {str(e)[:50]}...")
        
        # Prueba 2: Ejecutar ejemplo
        print("   üìÑ Prueba ejemplo de uso:")
        if Path("ejemplo_google_cloud_api_keys.py").exists():
            print("      ‚úÖ Archivo de ejemplo encontrado")
            results['example_execution'] = True
            
            # Intentar verificar sintaxis
            try:
                with open("ejemplo_google_cloud_api_keys.py", 'r', encoding='utf-8') as f:
                    content = f.read()
                
                compile(content, "ejemplo_google_cloud_api_keys.py", 'exec')
                print("      ‚úÖ Sintaxis del ejemplo v√°lida")
                
            except SyntaxError as e:
                print(f"      ‚ö†Ô∏è Error sintaxis: {str(e)[:30]}...")
            except Exception as e:
                print(f"      ‚ö†Ô∏è Error verificando ejemplo: {str(e)[:30]}...")
        else:
            print("      ‚ùå Archivo de ejemplo no encontrado")
        
        # Prueba 3: Verificar configuraciones creadas
        print("   ‚öôÔ∏è Prueba archivos de configuraci√≥n:")
        config_files = [
            "backend/requirements.txt",
            "aria_google_cloud_integration.py",
            "instalar_google_cloud_client.py"
        ]
        
        files_found = 0
        for config_file in config_files:
            if Path(config_file).exists():
                files_found += 1
                print(f"      ‚úÖ {config_file}")
            else:
                print(f"      ‚ùå {config_file}")
        
        if files_found >= 2:
            results['config_creation'] = True
        
        return results
    
    def generate_report(self) -> Dict:
        """Genera reporte completo de verificaci√≥n"""
        print(f"\nüìä GENERANDO REPORTE COMPLETO")
        print("-" * 30)
        
        # Ejecutar todas las verificaciones
        verification_data = {
            'timestamp': datetime.now().isoformat(),
            'python_env': self.verify_python_environment(),
            'google_cloud_client': self.verify_google_cloud_client(),
            'aria_integration': self.verify_aria_integration(),
            'gcloud_cli': self.verify_gcloud_cli(),
            'integration_tests': self.run_integration_tests()
        }
        
        # Calcular puntuaci√≥n general
        scores = []
        
        # Python Environment (20%)
        python_score = 0
        if verification_data['python_env']['python_version']:
            python_score += 25
        if verification_data['python_env']['virtual_env']:
            python_score += 25
        google_packages = len([p for p in verification_data['python_env']['packages_installed'].values() if p])
        python_score += min(50, google_packages * 8)  # M√°ximo 50 por paquetes
        scores.append(('Python Environment', python_score, 20))
        
        # Google Cloud Client (25%)
        client_score = 0
        if any(verification_data['google_cloud_client']['import_methods'].values()):
            client_score += 50
        if verification_data['google_cloud_client']['auth_available']:
            client_score += 30
        if verification_data['google_cloud_client']['credentials_configured']:
            client_score += 20
        scores.append(('Google Cloud Client', client_score, 25))
        
        # ARIA Integration (25%)
        aria_score = 0
        if verification_data['aria_integration']['auto_learning_available']:
            aria_score += 40
        aria_score += len(verification_data['aria_integration']['config_files_found']) * 15
        if verification_data['aria_integration']['google_cloud_apis_available']:
            aria_score += 30
        scores.append(('ARIA Integration', min(100, aria_score), 25))
        
        # gcloud CLI (15%)
        gcloud_score = 0
        if verification_data['gcloud_cli']['gcloud_installed']:
            gcloud_score += 40
        if verification_data['gcloud_cli']['authenticated']:
            gcloud_score += 30
        if verification_data['gcloud_cli']['project_configured']:
            gcloud_score += 30
        scores.append(('gcloud CLI', gcloud_score, 15))
        
        # Integration Tests (15%)
        tests_score = 0
        test_results = verification_data['integration_tests']
        if test_results['aria_google_cloud_test']:
            tests_score += 40
        if test_results['example_execution']:
            tests_score += 30
        if test_results['config_creation']:
            tests_score += 30
        scores.append(('Integration Tests', tests_score, 15))
        
        # Calcular puntuaci√≥n final
        final_score = sum(score * weight / 100 for _, score, weight in scores)
        
        # Determinar estado general
        if final_score >= 80:
            status = "üéâ EXCELENTE"
            color = "Verde"
        elif final_score >= 60:
            status = "‚úÖ BUENO"
            color = "Amarillo"
        elif final_score >= 40:
            status = "‚ö†Ô∏è PARCIAL"
            color = "Naranja"
        else:
            status = "‚ùå NECESITA TRABAJO"
            color = "Rojo"
        
        report = {
            'verification_data': verification_data,
            'scores': scores,
            'final_score': final_score,
            'status': status,
            'color': color,
            'recommendations': self.recommendations
        }
        
        return report
    
    def print_report(self, report: Dict):
        """Imprime reporte formateado"""
        print(f"\n" + "="*60)
        print(f"üìã REPORTE FINAL DE VERIFICACI√ìN")
        print(f"="*60)
        
        # Estado general
        print(f"üéØ ESTADO GENERAL: {report['status']}")
        print(f"üìä PUNTUACI√ìN: {report['final_score']:.1f}/100")
        print()
        
        # Desglose por categor√≠as
        print(f"üìà DESGLOSE POR CATEGOR√çAS:")
        for category, score, weight in report['scores']:
            bar_length = 20
            filled_length = int(bar_length * score / 100)
            bar = '‚ñà' * filled_length + '‚ñë' * (bar_length - filled_length)
            print(f"   {category:<20} {bar} {score:>3.0f}% (peso {weight}%)")
        
        print()
        
        # Recomendaciones
        if report['recommendations']:
            print(f"üí° RECOMENDACIONES ({len(report['recommendations'])}):")
            for i, rec in enumerate(report['recommendations'], 1):
                print(f"   {i}. {rec}")
            print()
        
        # Pr√≥ximos pasos
        print(f"üöÄ PR√ìXIMOS PASOS SUGERIDOS:")
        if report['final_score'] < 40:
            print("   1. Instalar dependencias faltantes")
            print("   2. Configurar gcloud CLI")
            print("   3. Verificar integraci√≥n ARIA")
        elif report['final_score'] < 60:
            print("   1. Completar configuraci√≥n de Google Cloud")
            print("   2. Probar ejemplos de uso")
            print("   3. Configurar proyecto y credenciales")
        elif report['final_score'] < 80:
            print("   1. Optimizar configuraci√≥n existente")
            print("   2. Probar todas las funcionalidades")
            print("   3. Documentar configuraci√≥n personalizada")
        else:
            print("   1. ¬°Sistema listo para producci√≥n!")
            print("   2. Explorar funcionalidades avanzadas")
            print("   3. Implementar monitoreo y logging")
        
        print(f"\nüìö DOCUMENTACI√ìN:")
        print(f"   ‚Ä¢ Google Cloud API Keys: https://cloud.google.com/python/docs/reference/apikeys/latest")
        print(f"   ‚Ä¢ Autenticaci√≥n: https://cloud.google.com/docs/authentication")
        print(f"   ‚Ä¢ ARIA Integration: aria_google_cloud_integration.py")
        
        print(f"\n‚è∞ Reporte generado: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print("="*60)
    
    def save_report(self, report: Dict):
        """Guarda reporte en archivo JSON"""
        try:
            report_file = Path(f"google_cloud_verification_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json")
            
            with open(report_file, 'w', encoding='utf-8') as f:
                json.dump(report, f, indent=2, ensure_ascii=False, default=str)
            
            print(f"üíæ Reporte guardado: {report_file}")
            
        except Exception as e:
            print(f"‚ùå Error guardando reporte: {e}")

def main():
    """Funci√≥n principal de verificaci√≥n"""
    verificator = GoogleCloudAriaVerificator()
    
    print("üéØ Este verificador analiza:")
    print("   ‚Ä¢ Entorno Python y dependencias")
    print("   ‚Ä¢ Cliente Google Cloud API Keys")
    print("   ‚Ä¢ Integraci√≥n con sistema ARIA")
    print("   ‚Ä¢ Configuraci√≥n de gcloud CLI")
    print("   ‚Ä¢ Pruebas de funcionalidad")
    print()
    
    choice = input("¬øEjecutar verificaci√≥n completa? (s/n): ").lower()
    
    if choice == 's':
        # Generar y mostrar reporte
        report = verificator.generate_report()
        verificator.print_report(report)
        
        # Opci√≥n de guardar
        save_choice = input("\nüíæ ¬øGuardar reporte en archivo JSON? (s/n): ").lower()
        if save_choice == 's':
            verificator.save_report(report)
        
        print(f"\nüéâ ¬°Verificaci√≥n completada!")
        return True
    else:
        print("üëã Verificaci√≥n cancelada")
        return False

if __name__ == "__main__":
    main()